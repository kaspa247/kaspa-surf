<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kaspa Surf - Curated Kaspa Cryptocurrency Links & Resources</title>
  <meta name="description" content="Ride the BlockDAG wave with Kaspa Surf: A curated directory of Kaspa links including wallets, explorers, exchanges, mining pools, and community resources for the fastest PoW blockchain.">
  <meta name="keywords" content="Kaspa links, Kaspa resources, BlockDAG directory, Kaspa wallets, Kaspa explorers, Kaspa mining, cryptocurrency links">
  <meta name="robots" content="index, follow">

  <meta property="og:title" content="Kaspa Surf - Essential Kaspa Crypto Links">
  <meta property="og:description" content="Discover curated resources for Kaspa: Wallets, exchanges, mining, and more.">
  <meta property="og:url" content="https://kaspa.surf/">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://kaspa.surf/favicon.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Kaspa Surf - Curated Kaspa Links">
  <meta name="twitter:description" content="Ride the wave of Kaspa resources.">

  <link rel="canonical" href="https://kaspa.surf/">
  <link rel="icon" href="/favicon.png" type="image/x-icon">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Kaspa Surf",
    "url": "https://kaspa.surf/",
    "description": "Curated directory of Kaspa cryptocurrency resources",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://kaspa.surf/?q={search_term_string}",
      "query-input": "required name=search_term_string"
    },
    "mainEntity": {
      "@type": "CollectionPage",
      "name": "Kaspa Links Directory",
      "hasPart": [
        {"@type": "ItemList", "name": "Featured Links", "itemListElement": ["https://kaspa.org/", "https://explorer.kaspa.org/"]},
        {"@type": "ItemList", "name": "Wallets", "itemListElement": ["https://wallet.kaspanet.io/"]}
      ]
    }
  }
  </script>
</head>

<body class="dark">
<header>
  <h1>Kaspa Surf ðŸŒŠ</h1>
  <p class="subtitle">Ride the BlockDAG wave: Curated Kaspa links</p>

  <div id="kas-price" style="min-height:44px">Loading KAS priceâ€¦</div>

  <button id="mode-toggle" aria-label="Toggle light/dark mode">ðŸŒ™</button>
</header>

<main>
  <div class="ks-wrap">
    <div class="ks-header">
      <div>
        <h1 class="ks-title">Live Kaspa Exchange Prices</h1>
        <div class="ks-sub" id="ks-updated">Loadingâ€¦</div>
      </div>

      <div class="ks-cards">
        <div class="ks-card">
          <div class="ks-label">VWAP</div>
          <div class="ks-value" id="ks-vwap">â€”</div>
        </div>
        <div class="ks-card">
          <div class="ks-label">Avg Price</div>
          <div class="ks-value" id="ks-avg">â€”</div>
        </div>
        <div class="ks-card">
          <div class="ks-label">24h Volume</div>
          <div class="ks-value" id="ks-vol">â€”</div>
        </div>
        <div class="ks-card">
          <div class="ks-label">Exchanges</div>
          <div class="ks-value" id="ks-excount">â€”</div>
        </div>
      </div>
    </div>

    <div class="ks-grid">
      <div class="ks-panel">
        <div class="ks-panel-head">
          <h2 class="ks-h2">Kaspa Chart</h2>
          <div class="ks-controls">
            <button class="ks-btn" data-range="6">6h</button>
            <button class="ks-btn" data-range="24">24h</button>
            <button class="ks-btn" data-range="72">3d</button>
            <button class="ks-btn" id="ks-clear">Clear</button>
          </div>
        </div>
        <canvas id="ks-chart" height="110"></canvas>
        <div class="ks-sub">Chart updates every 60s from api.kaspa.surf and stored in this browser.</div>
      </div>

      <div class="ks-panel">
        <div class="ks-panel-head">
          <h2 class="ks-h2">Leaderboard</h2>
          <div class="ks-controls">
            <input id="ks-filter" class="ks-input" placeholder="Filter exchangeâ€¦" />
            <select id="ks-sort" class="ks-select">
              <option value="volume_24h:desc">Sort: Volume â†“</option>
              <option value="volume_24h:asc">Sort: Volume â†‘</option>
              <option value="last:desc">Sort: Price â†“</option>
              <option value="last:asc">Sort: Price â†‘</option>
              <option value="change_pct:desc">Sort: Change â†“</option>
              <option value="change_pct:asc">Sort: Change â†‘</option>
            </select>
          </div>
        </div>

        <div class="ks-tablewrap">
          <table class="ks-table">
            <thead>
              <tr>
                <th>Exchange</th>
                <th class="r">Last</th>
                <th class="r">24h High</th>
                <th class="r">24h Low</th>
                <th class="r">24h Vol</th>
                <th class="r">Change</th>
                <th class="r">Spread vs VWAP</th>
              </tr>
            </thead>
            <tbody id="ks-tbody">
              <tr><td colspan="7" class="ks-sub">Loadingâ€¦</td></tr>
            </tbody>
          </table>
        </div>

        <div class="ks-footer" id="ks-notes"></div>
      </div>
    </div>
  </div>

  <!-- Chart.js (defer so it doesn't block first paint) -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
(() => {
  const API = "https://api.kaspa.surf";
  const POLL_MS = 60_000;
  const TICKER_PATH = "/v1/ticker/kaspa";

  const CHART_KEY = "kaspa_surf_kas_chart_points_v1";
  const LAST_TICKER_KEY = "kaspa_surf_last_ticker_v1";

  const el = (id) => document.getElementById(id);

  const fmtUsd = (n, d=5) =>
    Number(n).toLocaleString(undefined, { minimumFractionDigits:d, maximumFractionDigits:d });

  const fmtNum = (n) =>
    Number(n).toLocaleString(undefined, { maximumFractionDigits:0 });

  const fmtPct = (n) => (n == null ? "â€”" : `${Number(n).toFixed(2)}%`);

  function colorForChange(pct) {
    if (pct == null) return "var(--text-color)";
    return pct >= 0 ? "lime" : "red";
  }

  // --- Robust timestamp parsing for nanoseconds (832918830)
  // Some browsers fail to parse 9-digit fractional seconds.
  function parseApiTimestamp(ts) {
    if (!ts || typeof ts !== "string") return null;

    // Convert "....05.832918830+00:00" -> "....05.832Z" (milliseconds only)
    // Keep timezone if present.
    const m = ts.match(/^(.+?)(\.\d+)?(Z|[+-]\d\d:\d\d)$/);
    if (!m) {
      const d = new Date(ts);
      return Number.isNaN(d.valueOf()) ? null : d;
    }

    const base = m[1];
    const frac = m[2] || "";
    const zone = m[3];

    // take first 3 digits of fractional seconds for ms
    let ms = "000";
    if (frac) {
      const digits = frac.slice(1); // remove dot
      ms = (digits + "000").slice(0, 3);
    }

    const isoMs = `${base}.${ms}${zone}`;
    const d = new Date(isoMs);
    return Number.isNaN(d.valueOf()) ? null : d;
  }

  function loadJSON(key, fallback) {
    try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
    catch { return fallback; }
  }
  function saveJSON(key, value) {
    try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
  }

  function prunePoints(points) {
    const cutoff = Date.now() - 7 * 24 * 60 * 60 * 1000;
    return (points || []).filter(p => p && p.t >= cutoff && Number.isFinite(p.v));
  }

  let rangeHours = 24;
  let lastData = loadJSON(LAST_TICKER_KEY, null);

  // Pick exchange for % change display:
  // highest volume_24h where last != null and change_pct != null and volume_24h > 0
  function pickBestChangeExchange(exchanges) {
    return (exchanges || [])
      .filter(x => x && x.exchange && x.last != null && x.change_pct != null)
      .sort((a,b) => (b.volume_24h ?? 0) - (a.volume_24h ?? 0))[0];
  }

  function setHeaderPrice(d) {
    const box = el("kas-price");
    if (!box) return;

    if (!d) {
      box.textContent = "Loading KAS priceâ€¦";
      return;
    }

    const price = d?.aggregate?.vwap ?? d?.aggregate?.avg_price ?? null;
    const vol24 = d?.aggregate?.total_volume_24h ?? null;

    const best = pickBestChangeExchange(d.exchanges);
    const changePct = best?.change_pct;

    const changeHtml = (changePct == null)
      ? ""
      : ` <span style="color:${changePct >= 0 ? "lime" : "red"}">(${Number(changePct).toFixed(2)}%)</span>
          <small style="opacity:.8">via ${best.exchange}</small>`;

    const ts = parseApiTimestamp(d.timestamp);
    const updated = ts ? ts.toLocaleTimeString() : "â€”";

    box.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:6px">
        <div><strong>KAS:</strong> ${price == null ? "â€”" : `$${fmtUsd(price, 5)}`} ${changeHtml}</div>
        <div style="opacity:.85;font-size:.95em">
          24h Volume: ${vol24 == null ? "â€”" : fmtNum(vol24)} &nbsp;â€¢&nbsp; Updated: ${updated}
        </div>
      </div>
    `;
  }

  function setCards(d) {
    const vwap = d?.aggregate?.vwap ?? null;
    const avg  = d?.aggregate?.avg_price ?? null;
    const vol  = d?.aggregate?.total_volume_24h ?? null;
    const exc  = d?.aggregate?.exchange_count ?? null;

    el("ks-vwap").textContent = vwap == null ? "â€”" : `$${fmtUsd(vwap, 6)}`;
    el("ks-avg").textContent  = avg  == null ? "â€”" : `$${fmtUsd(avg, 6)}`;
    el("ks-vol").textContent  = vol  == null ? "â€”" : fmtNum(vol);
    el("ks-excount").textContent = exc == null ? "â€”" : String(exc);

    const ts = parseApiTimestamp(d?.timestamp);
    el("ks-updated").textContent = ts ? `Updated: ${ts.toLocaleString()}` : "Updated: â€”";
  }

  function spreadPct(last, vwap) {
    if (last == null || vwap == null) return null;
    return ((last - vwap) / vwap) * 100;
  }

  function parseSort(v) {
    const [key, dir] = String(v || "volume_24h:desc").split(":");
    return { key, dir };
  }

  function renderTableFromState() {
    const d = lastData;
    const tbody = el("ks-tbody");
    if (!tbody) return;

    if (!d || !Array.isArray(d.exchanges)) {
      tbody.innerHTML = `<tr><td colspan="7" class="ks-sub">Loadingâ€¦</td></tr>`;
      el("ks-notes").innerHTML = "";
      return;
    }

    const vwap = d?.aggregate?.vwap ?? null;
    const filter = el("ks-filter").value.trim().toLowerCase();
    const { key, dir } = parseSort(el("ks-sort").value);

    const rows = (d.exchanges || [])
      .filter(x => x && x.exchange)
      .filter(x => x.last != null)
      .filter(x => !filter || x.exchange.toLowerCase().includes(filter))
      .map(x => ({ ...x, spread_vs_vwap: spreadPct(x.last, vwap) }))
      .sort((a, b) => {
        const av = (a[key] == null ? -Infinity : a[key]);
        const bv = (b[key] == null ? -Infinity : b[key]);
        return dir === "asc" ? av - bv : bv - av;
      });

    tbody.innerHTML = "";

    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="7" class="ks-sub">No matches.</td></tr>`;
      el("ks-notes").innerHTML = "";
      return;
    }

    for (const x of rows) {
      const ch = x.change_pct;
      const sp = x.spread_vs_vwap;
      const spText = sp == null ? "â€”" : `${sp.toFixed(2)}%`;

      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td class="mono">${x.exchange}</td>
          <td class="r mono">$${fmtUsd(x.last, 5)}</td>
          <td class="r mono">${x.high == null ? "â€”" : `$${fmtUsd(x.high, 5)}`}</td>
          <td class="r mono">${x.low  == null ? "â€”" : `$${fmtUsd(x.low, 5)}`}</td>
          <td class="r mono">${x.volume_24h == null ? "â€”" : fmtNum(x.volume_24h)}</td>
          <td class="r mono" style="color:${colorForChange(ch)}">${fmtPct(ch)}</td>
          <td class="r mono">${spText}</td>
        </tr>
      `);
    }

    const bySpread = rows
      .filter(r => r.spread_vs_vwap != null)
      .sort((a,b)=>b.spread_vs_vwap-a.spread_vs_vwap);

    const top = bySpread[0];
    const bot = bySpread[bySpread.length - 1];

    el("ks-notes").innerHTML = (top && bot) ? `
      <div class="ks-sub">
        Highest vs VWAP: <strong>${top.exchange}</strong> (${top.spread_vs_vwap.toFixed(2)}%) Â·
        Lowest vs VWAP: <strong>${bot.exchange}</strong> (${bot.spread_vs_vwap.toFixed(2)}%)
      </div>
    ` : "";
  }

  function updateChartStoreFromData(d) {
    const vwap = d?.aggregate?.vwap ?? null;
    if (vwap == null) return;

    let points = prunePoints(loadJSON(CHART_KEY, []));
    points.push({ t: Date.now(), v: Number(vwap) });
    points = prunePoints(points);
    saveJSON(CHART_KEY, points);
  }

  function bootChartWhenReady(cb) {
    if (window.Chart) return cb();
    requestAnimationFrame(() => bootChartWhenReady(cb));
  }

  function renderChart(chart, points) {
    const cutoff = Date.now() - rangeHours * 60 * 60 * 1000;
    const view = (points || []).filter(p => p.t >= cutoff);

    chart.data.labels = view.map(p => new Date(p.t).toLocaleTimeString());
    chart.data.datasets[0].data = view.map(p => p.v);
    chart.update();
  }

  function getTimestampMs(d) {
    const dt = parseApiTimestamp(d?.timestamp);
    return dt ? dt.valueOf() : NaN;
  }

  async function fetchTickerSmart() {
    const url = `${API}${TICKER_PATH}`;

    // First try: cache-friendly
    let r = await fetch(url, { cache: "default" });

    if (!r.ok) {
      const bust = `${url}?_=${Date.now()}`;
      r = await fetch(bust, { cache: "no-store" });
    } else {
      const clone = r.clone();
      const d = await clone.json().catch(() => null);
      const ts = getTimestampMs(d);
      const stale = Number.isFinite(ts) ? (Date.now() - ts > 120_000) : false;

      if (!stale) return d;

      // stale -> refresh once
      const bust = `${url}?_=${Date.now()}`;
      r = await fetch(bust, { cache: "no-store" });
    }

    if (!r.ok) throw new Error(`API HTTP ${r.status}`);
    return r.json();
  }

  async function refreshTicker({ silent = false } = {}) {
    try {
      const d = await fetchTickerSmart();

      lastData = d;
      saveJSON(LAST_TICKER_KEY, d);

      setHeaderPrice(d);
      setCards(d);
      renderTableFromState();

      updateChartStoreFromData(d);

      if (window.__kaspaSurfChart) {
        const pts = prunePoints(loadJSON(CHART_KEY, []));
        renderChart(window.__kaspaSurfChart, pts);
      }
    } catch (e) {
      console.error(e);
      if (!silent) el("ks-updated").textContent = "API error â€” check console";
    }
  }

  // ---- Boot: render cached instantly
  if (lastData) {
    setHeaderPrice(lastData);
    setCards(lastData);
  }
  renderTableFromState();

  // ---- Chart init when Chart.js ready
  bootChartWhenReady(() => {
    const ctx = el("ks-chart").getContext("2d");
    const chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "KAS (VWAP)",
          data: [],
          tension: 0.2,
          pointRadius: 0
        }]
      },
      options: {
        responsive: true,
        animation: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: { label: (item) => `$${fmtUsd(item.parsed.y, 6)}` }
          }
        },
        scales: {
          x: { ticks: { maxTicksLimit: 6 } },
          y: { ticks: { callback: (v) => `$${v}` } }
        }
      }
    });

    window.__kaspaSurfChart = chart;
    const pts = prunePoints(loadJSON(CHART_KEY, []));
    renderChart(chart, pts);
  });

  // ---- Controls (local only)
  document.querySelectorAll(".ks-btn[data-range]").forEach(btn => {
    btn.addEventListener("click", () => {
      rangeHours = Number(btn.dataset.range);
      const pts = prunePoints(loadJSON(CHART_KEY, []));
      if (window.__kaspaSurfChart) renderChart(window.__kaspaSurfChart, pts);
    });
  });

  el("ks-clear").addEventListener("click", () => {
    localStorage.removeItem(CHART_KEY);
    if (window.__kaspaSurfChart) renderChart(window.__kaspaSurfChart, []);
  });

  el("ks-filter").addEventListener("input", () => renderTableFromState());
  el("ks-sort").addEventListener("change", () => renderTableFromState());

  // ---- Background refresh ASAP + poll
  refreshTicker({ silent: true });
  setInterval(() => refreshTicker({ silent: true }), POLL_MS);
})();
</script>
</body>
</html>