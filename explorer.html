<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kaspa Surf — Address Explorer</title>
  <style>
    :root{
      --bg:#0a0f1a; --panel:#121a2a; --panel2:#1c2333;
      --text:#e0e0e0; --muted:#aab3c5; --accent:#00b4d8; --link:#00d4ff;
      --ok:#4ade80; --bad:#ff5c5c;
      --r:14px;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,var(--bg),var(--panel2));color:var(--text);}
    header{padding:16px 18px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    a{color:var(--link);text-decoration:none}
    main{padding:0 18px 22px;max-width:1200px;margin:0 auto;}
    .card{background:rgba(18,26,42,.82);border:1px solid rgba(255,255,255,.06);border-radius:var(--r);padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-top:12px;}
    .card h2{margin:0 0 10px;font-size:13px;color:var(--muted);font-weight:650}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,button,select{
      background:rgba(255,255,255,.05);color:var(--text);border:1px solid rgba(255,255,255,.10);
      padding:10px 12px;border-radius:12px;outline:none;
    }
    button{cursor:pointer;border-color:rgba(0,180,216,.35)}
    button:hover{background:rgba(0,180,216,.10)}
    .status{font-size:12px;color:var(--muted);margin-top:8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .bad{color:var(--bad)} .ok{color:var(--ok)}
    .kvs{display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr));margin-top:10px;}
    .kv{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px;}
    .kv .k{font-size:11px;color:var(--muted)}
    .kv .v{font-size:16px;margin-top:4px;font-weight:700}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.07);vertical-align:top}
    th{color:var(--muted);font-weight:650;text-align:left}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
<header>
  <div class="row">
    <h1>Kaspa Surf — Address Explorer</h1>
    <span class="status">· <a href="dashboard.html">Dashboard</a></span>
  </div>
  <div class="row">
    <span class="status">API: <a id="apiLink" href="#" target="_blank" rel="noreferrer">rest-api.kaspa.surf</a></span>
    <span class="status">Docs: <a id="docsLink" href="#" target="_blank" rel="noreferrer">/docs</a></span>
  </div>
</header>

<main>
  <section class="card">
    <h2>Lookup</h2>
    <div class="controls">
      <input id="addr" class="mono" style="min-width:360px;flex:1" placeholder="kaspa:..." />
      <button id="go">Fetch</button>
      <label class="status">Txs:
        <select id="txLimit">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
        </select>
      </label>
    </div>
    <div class="status" id="err"></div>
    <div class="kvs" id="kvs"></div>
  </section>

  <section class="card">
    <h2>UTXOs</h2>
    <div class="status" id="utxoMeta">—</div>
    <div style="overflow:auto;margin-top:8px">
      <table>
        <thead>
          <tr><th>Amount</th><th>TxID</th><th>Index</th><th>Script Addr</th></tr>
        </thead>
        <tbody id="utxos"></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <h2>Recent Transactions</h2>
    <div class="status" id="txMeta">—</div>
    <div style="overflow:auto;margin-top:8px">
      <table>
        <thead>
          <tr><th>Time</th><th>TxID</th><th>Direction / Notes</th></tr>
        </thead>
        <tbody id="txs"></tbody>
      </table>
    </div>
    <div class="status">If your REST server exposes a tx-history endpoint, this will auto-detect it. If not, we can add a small “tx history service” later.</div>
  </section>
</main>

<script>
  const API_BASE = "https://rest-api.kaspa.surf";
  const DOCS_URL = API_BASE + "/docs";
  const $ = (id) => document.getElementById(id);

  $("apiLink").href = API_BASE; $("apiLink").textContent = API_BASE.replace("https://","");
  $("docsLink").href = DOCS_URL;

  const fmtNum = (n) => {
    if (n === null || n === undefined || n === "") return "—";
    const x = Number(n);
    if (!Number.isFinite(x)) return String(n);
    return x.toLocaleString(undefined, { maximumFractionDigits: 8 });
  };
  const fmtDate = (msOrIso) => {
    if (!msOrIso) return "—";
    const d = typeof msOrIso === "number" ? new Date(msOrIso) : new Date(msOrIso);
    return isNaN(d.getTime()) ? String(msOrIso) : d.toLocaleString();
  };

  async function apiGet(path) {
    const res = await fetch(API_BASE + path, { headers: { "accept": "application/json" }});
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const ct = res.headers.get("content-type") || "";
    return ct.includes("application/json") ? res.json() : res.text();
  }

  function kvGrid(items){
    $("kvs").innerHTML = items.map(({k,v}) => `
      <div class="kv"><div class="k">${k}</div><div class="v">${v}</div></div>
    `).join("");
  }

  async function firstWorkingJson(paths) {
    // tries endpoints until one works
    for (const p of paths) {
      try {
        const data = await apiGet(p);
        return { path: p, data };
      } catch (e) { /* keep trying */ }
    }
    return null;
  }

  async function loadAddress(addr){
    $("err").textContent = "";
    $("utxos").innerHTML = "";
    $("txs").innerHTML = "";
    $("utxoMeta").textContent = "—";
    $("txMeta").textContent = "—";
    $("kvs").innerHTML = "";

    // balance + utxos are known-good on kaspa-rest-server setups
    let bal, utxos;
    try {
      [bal, utxos] = await Promise.all([
        apiGet(`/addresses/${encodeURIComponent(addr)}/balance`),
        apiGet(`/addresses/${encodeURIComponent(addr)}/utxos`)
      ]);
    } catch (e) {
      $("err").innerHTML = `<span class="bad">Fetch failed:</span> ${e.message}`;
      return;
    }

    const confirmed = bal?.balance ?? bal?.confirmed ?? bal?.confirmedBalance ?? bal?.confirmed_balance ?? bal?.confirmedBalanceSompi;
    const pending = bal?.pending ?? bal?.pendingBalance ?? bal?.pending_balance ?? bal?.pendingBalanceSompi;

    kvGrid([
      { k:"Address", v:`<span class="mono">${addr}</span>` },
      { k:"Confirmed", v:fmtNum(confirmed) },
      { k:"Pending", v:fmtNum(pending) },
      { k:"UTXO count", v:fmtNum(Array.isArray(utxos) ? utxos.length : "—") },
    ]);

    // UTXO table
    if (Array.isArray(utxos) && utxos.length) {
      $("utxoMeta").textContent = `Showing ${Math.min(utxos.length, 200)} UTXOs`;
      $("utxos").innerHTML = utxos.slice(0,200).map(u => {
        const amt = u?.amount ?? u?.utxoEntry?.amount ?? u?.value ?? "—";
        const txid = u?.outpoint?.transactionId ?? u?.outpoint?.transaction_id ?? u?.transactionId ?? u?.txid ?? "—";
        const idx = u?.outpoint?.index ?? u?.outpoint?.outputIndex ?? u?.index ?? "—";
        const spkAddr = u?.utxoEntry?.scriptPublicKeyAddress ?? u?.scriptPublicKeyAddress ?? u?.address ?? "—";
        return `<tr>
          <td>${fmtNum(amt)}</td>
          <td class="mono">${String(txid).slice(0,18)}…</td>
          <td>${fmtNum(idx)}</td>
          <td class="mono">${String(spkAddr).slice(0,22)}…</td>
        </tr>`;
      }).join("");
    } else {
      $("utxoMeta").textContent = "No UTXOs returned.";
      $("utxos").innerHTML = `<tr><td colspan="4" class="status">No UTXOs.</td></tr>`;
    }

    // Recent txs — try common endpoint names used by Kaspa REST server variants
    const limit = Number($("txLimit").value || "25");
    const candidates = [
      // most common
      `/addresses/${encodeURIComponent(addr)}/transactions?limit=${limit}`,
      `/addresses/${encodeURIComponent(addr)}/transactions`,
      // other variants people run
      `/address/${encodeURIComponent(addr)}/transactions?limit=${limit}`,
      `/addresses/${encodeURIComponent(addr)}/txs?limit=${limit}`,
      `/addresses/${encodeURIComponent(addr)}/full`, // sometimes includes txs
    ];

    const found = await firstWorkingJson(candidates);

    if (!found) {
      $("txMeta").innerHTML = `<span class="bad">No tx-history endpoint found</span> (we can wire one up if you want).`;
      $("txs").innerHTML = `<tr><td colspan="3" class="status">Tx history not available from this API build.</td></tr>`;
      return;
    }

    const { path, data } = found;
    // normalize: allow {transactions:[...]} or [...] or "full" objects that contain txs
    const txs = Array.isArray(data) ? data
      : Array.isArray(data?.transactions) ? data.transactions
      : Array.isArray(data?.txs) ? data.txs
      : Array.isArray(data?.addressTransactions) ? data.addressTransactions
      : Array.isArray(data?.transactionHistory) ? data.transactionHistory
      : [];

    $("txMeta").textContent = `Endpoint: ${path} · Showing ${Math.min(txs.length, limit)} txs`;

    if (!txs.length) {
      $("txs").innerHTML = `<tr><td colspan="3" class="status">No transactions returned.</td></tr>`;
      return;
    }

    $("txs").innerHTML = txs.slice(0,limit).map(t => {
      const txid = t?.transactionId ?? t?.txid ?? t?.id ?? t?.hash ?? "—";
      const time = t?.blockTime ?? t?.timestamp ?? t?.time ?? t?.acceptedAt ?? null;
      // Optional: direction if API includes it
      const dir = t?.direction ?? t?.type ?? "";
      const note = dir ? String(dir) : "—";
      return `<tr>
        <td>${fmtDate(time)}</td>
        <td class="mono">${String(txid).slice(0,24)}…</td>
        <td>${note}</td>
      </tr>`;
    }).join("");
  }

  function getQueryAddr(){
    const u = new URL(location.href);
    return u.searchParams.get("address") || "";
  }

  $("go").onclick = async () => {
    const addr = $("addr").value.trim();
    if (!addr) return;
    history.replaceState(null, "", `?address=${encodeURIComponent(addr)}`);
    await loadAddress(addr);
  };

  (async () => {
    const q = getQueryAddr();
    if (q) { $("addr").value = q; await loadAddress(q); }
  })();
</script>
</body>
</html>
