<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kaspa Surf - Live Exchange Prices</title>

  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
</head>

<body class="dark">
<header>
  <div class="header-left">
    <a href="https://kaspa.surf">
      <img src="https://kaspa.surf/img/kaspa-surf-logo.png" alt="Kaspa Surf Icon" id="kaspa-surf-icon">
    </a>
  </div>
  <div class="header-right">
    <p><a href="https://kaspa.surf/exchange-prices">Exchange Prices</a><span class="badge hot">Betaüî•</span></p>
    <div id="kas-price"></div>
    <button id="mode-toggle" aria-label="Toggle light/dark mode">üåô</button>
  </div>
</header>

<main>
  <div class="ks-wrap">
    <div class="ks-header">
      <div>
        <h1 class="ks-title">Live Kaspa Exchange Prices</h1>
        <div class="ks-sub" id="ks-updated">Loading‚Ä¶</div>
        <div class="ks-sub" id="ks-error" style="display:none;color:#ff6b6b;margin-top:6px;"></div>
      </div>

      <div class="ks-cards">
        <div class="ks-card">
          <div class="ks-label">VWAP</div>
          <div class="ks-value" id="ks-vwap">‚Äî</div>
        </div>
        <div class="ks-card">
          <div class="ks-label">Avg Price</div>
          <div class="ks-value" id="ks-avg">‚Äî</div>
        </div>
        <div class="ks-card">
          <div class="ks-label">24h Volume</div>
          <div class="ks-value" id="ks-vol">‚Äî</div>
        </div>
        <div class="ks-card">
          <div class="ks-label">Exchanges</div>
          <div class="ks-value" id="ks-excount">‚Äî</div>
        </div>
      </div>
    </div>

    <div class="ks-grid">
      <div class="ks-panel">
        <div class="ks-panel-head">
          <h2 class="ks-h2">Kaspa Chart</h2>
          <div class="ks-controls">
            <button class="ks-btn" data-range="6">6h</button>
            <button class="ks-btn" data-range="24">24h</button>
            <button class="ks-btn" data-range="72">3d</button>
            <button class="ks-btn" id="ks-clear">Clear Graph</button>
            <button class="ks-btn" id="ks-clear-all">Clear Cache</button>
          </div>
        </div>
        <canvas id="ks-chart" height="110"></canvas>
        <div class="ks-sub">Chart updates every 60s from api.kaspa.surf and stored in this browser.</div>
      </div>

      <div class="ks-panel">
        <div class="ks-panel-head">
          <h2 class="ks-h2">Leaderboard</h2>
          <div class="ks-controls">
            <input id="ks-filter" class="ks-input" placeholder="Filter exchange‚Ä¶" />
            <select id="ks-sort" class="ks-select">
              <option value="volume_24h:desc">Sort: Volume ‚Üì</option>
              <option value="volume_24h:asc">Sort: Volume ‚Üë</option>
              <option value="last:desc">Sort: Price ‚Üì</option>
              <option value="last:asc">Sort: Price ‚Üë</option>
              <option value="change_pct:desc">Sort: Change ‚Üì</option>
              <option value="change_pct:asc">Sort: Change ‚Üë</option>
            </select>
          </div>
        </div>

        <div class="ks-tablewrap">
          <table class="ks-table">
            <thead>
              <tr>
                <th>Exchange</th>
                <th class="r">Last</th>
                <th class="r">24h High</th>
                <th class="r">24h Low</th>
                <th class="r">24h Vol</th>
                <th class="r">Change</th>
                <th class="r">Spread vs VWAP</th>
              </tr>
            </thead>
            <tbody id="ks-tbody">
              <tr><td colspan="7" class="ks-sub">Loading‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>

        <div class="ks-footer" id="ks-notes"></div>
      </div>
    </div>
  </div>

  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  (() => {
    const API = "https://api.kaspa.surf";
    const TICKER_PATH = "/v1/ticker/kaspa";
    const POLL_MS = 60_000;

    const CHART_KEY = "kaspa_surf_kas_chart_points_v1";
    const LAST_TICKER_KEY = "kaspa_surf_last_ticker_v1";

    const el = (id) => document.getElementById(id);

    const fmtUsd = (n, d=5) =>
      Number(n).toLocaleString(undefined, { minimumFractionDigits:d, maximumFractionDigits:d });

    const fmtNum = (n) =>
      Number(n).toLocaleString(undefined, { maximumFractionDigits:0 });

    const fmtPct = (n) => (n == null ? "‚Äî" : `${Number(n).toFixed(2)}%`);

    function colorForChange(pct) {
      if (pct == null) return "var(--text-color)";
      return pct >= 0 ? "lime" : "red";
    }

    function loadJSON(key, fallback) {
      try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
      catch { return fallback; }
    }
    function saveJSON(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
    }
    function prunePoints(points) {
      const cutoff = Date.now() - 7 * 24 * 60 * 60 * 1000;
      return (points || []).filter(p => p && p.t >= cutoff && Number.isFinite(p.v));
    }

    let rangeHours = 24;
    let lastData = loadJSON(LAST_TICKER_KEY, null);

    function showError(msg) {
      const box = el("ks-error");
      if (!box) return;
      if (!msg) { box.style.display = "none"; box.textContent = ""; return; }
      box.style.display = "block";
      box.textContent = msg;
    }

    function spreadPct(last, vwap) {
      if (last == null || vwap == null) return null;
      return ((last - vwap) / vwap) * 100;
    }

    function parseSort(v) {
      const [key, dir] = String(v || "volume_24h:desc").split(":");
      return { key, dir };
    }

    function pickBestChangeExchange(exchanges) {
      return (exchanges || [])
        .filter(x => x && x.last != null && x.change_pct != null)
        .sort((a, b) => (b.volume_24h ?? 0) - (a.volume_24h ?? 0))[0];
    }

    function setHeaderPrice(d) {
      const box = el("kas-price");
      if (!box) return;

      if (!d) { box.textContent = "Loading KAS price‚Ä¶"; return; }

      const price = d?.aggregate?.vwap ?? d?.aggregate?.avg_price;
      const best = pickBestChangeExchange(d.exchanges);
      const changePct = best?.change_pct;

      const changeHtml = (changePct == null)
        ? ""
        : ` <span style="color:${changePct >= 0 ? "lime" : "red"}">(${changePct.toFixed(2)}%)</span>
            <small style="opacity:.8">via ${best.exchange}</small>`;

      box.innerHTML = `<strong>$${price == null ? "‚Äî" : fmtUsd(price, 5)} ${changeHtml}</strong>`;
    }

    function setCards(d) {
      const vwap = d?.aggregate?.vwap ?? null;
      const avg  = d?.aggregate?.avg_price ?? null;
      const vol  = d?.aggregate?.total_volume_24h ?? null;
      const exc  = d?.aggregate?.exchange_count ?? null;

      el("ks-vwap").textContent = vwap == null ? "‚Äî" : `$${fmtUsd(vwap, 6)}`;
      el("ks-avg").textContent  = avg  == null ? "‚Äî" : `$${fmtUsd(avg, 6)}`;
      el("ks-vol").textContent  = vol  == null ? "‚Äî" : fmtNum(vol);
      el("ks-excount").textContent = exc == null ? "‚Äî" : String(exc);

      const ts = d?.timestamp ? new Date(d.timestamp) : null;
      el("ks-updated").textContent =
        (ts && !Number.isNaN(ts.valueOf()))
          ? `Updated: ${ts.toLocaleString()}`
          : "Updated: ‚Äî";
    }

    function renderTableFromState() {
      const d = lastData;
      const tbody = el("ks-tbody");
      if (!tbody) return;

      if (!d || !Array.isArray(d.exchanges)) {
        tbody.innerHTML = `<tr><td colspan="7" class="ks-sub">Loading‚Ä¶</td></tr>`;
        el("ks-notes").innerHTML = "";
        return;
      }

      const vwap = d?.aggregate?.vwap ?? null;
      const filter = el("ks-filter").value.trim().toLowerCase();
      const { key, dir } = parseSort(el("ks-sort").value);

      const rows = (d.exchanges || [])
        .filter(x => x && x.exchange)
        .filter(x => !filter || x.exchange.toLowerCase().includes(filter))
        // keep exchanges with any meaningful fields
        .filter(x =>
          x.last != null ||
          x.high != null ||
          x.low != null ||
          x.volume_24h != null ||
          x.change_pct != null
        )
        .map(x => ({
          ...x,
          spread_vs_vwap: (x.last == null || vwap == null) ? null : spreadPct(x.last, vwap)
        }))
        .sort((a, b) => {
          const av = (a[key] == null ? -Infinity : a[key]);
          const bv = (b[key] == null ? -Infinity : b[key]);
          return dir === "asc" ? av - bv : bv - av;
        });

      tbody.innerHTML = "";

      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="ks-sub">No matches.</td></tr>`;
        el("ks-notes").innerHTML = "";
        return;
      }

      for (const x of rows) {
        const ch = x.change_pct;
        const sp = x.spread_vs_vwap;
        const spText = sp == null ? "‚Äî" : `${sp.toFixed(2)}%`;
        const lastText = (x.last == null) ? "‚Äî" : `$${fmtUsd(x.last, 5)}`;

        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td class="mono">${x.exchange}</td>
            <td class="r mono">${lastText}</td>
            <td class="r mono">${x.high == null ? "‚Äî" : `$${fmtUsd(x.high, 5)}`}</td>
            <td class="r mono">${x.low  == null ? "‚Äî" : `$${fmtUsd(x.low, 5)}`}</td>
            <td class="r mono">${x.volume_24h == null ? "‚Äî" : fmtNum(x.volume_24h)}</td>
            <td class="r mono" style="color:${colorForChange(ch)}">${fmtPct(ch)}</td>
            <td class="r mono">${spText}</td>
          </tr>
        `);
      }
    }

    function bootChartWhenReady(cb) {
      if (window.Chart) return cb();
      requestAnimationFrame(() => bootChartWhenReady(cb));
    }

    function renderChart(chart, points) {
      const cutoff = Date.now() - rangeHours * 60 * 60 * 1000;
      const view = (points || []).filter(p => p.t >= cutoff);
      chart.data.labels = view.map(p => new Date(p.t).toLocaleTimeString());
      chart.data.datasets[0].data = view.map(p => p.v);
      chart.update();
    }

    function updateChartStoreFromData(d) {
      const vwap = d?.aggregate?.vwap ?? null;
      if (vwap == null) return;

      let points = prunePoints(loadJSON(CHART_KEY, []));
      points.push({ t: Date.now(), v: Number(vwap) });
      points = prunePoints(points);
      saveJSON(CHART_KEY, points);
    }

    async function fetchTicker() {
      const url = `${API}${TICKER_PATH}?_=${Date.now()}`; // always cache-bust
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`API HTTP ${r.status}`);
      return r.json();
    }

    async function refreshTicker({ silent = false } = {}) {
      try {
        showError("");

        const d = await fetchTicker();
        lastData = d;
        saveJSON(LAST_TICKER_KEY, d);

        setHeaderPrice(d);
        setCards(d);
        renderTableFromState();
        updateChartStoreFromData(d);

        if (window.__kaspaSurfChart) {
          const pts = prunePoints(loadJSON(CHART_KEY, []));
          renderChart(window.__kaspaSurfChart, pts);
        }
      } catch (e) {
        console.error(e);
        if (!silent) showError(`API error: ${e?.message || e}`);
        el("ks-updated").textContent = "API error ‚Äî check console";
      }
    }

    // boot from cache (instant paint)
    if (lastData) {
      setHeaderPrice(lastData);
      setCards(lastData);
    }
    renderTableFromState();

    bootChartWhenReady(() => {
      const ctx = el("ks-chart").getContext("2d");
      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: "KAS (VWAP)",
            data: [],
            tension: 0.2,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          animation: false,
          plugins: { legend: { display: false } },
          scales: { x: { ticks: { maxTicksLimit: 6 } } }
        }
      });
      window.__kaspaSurfChart = chart;

      const pts = prunePoints(loadJSON(CHART_KEY, []));
      renderChart(chart, pts);
    });

    document.querySelectorAll(".ks-btn[data-range]").forEach(btn => {
      btn.addEventListener("click", () => {
        rangeHours = Number(btn.dataset.range);
        const pts = prunePoints(loadJSON(CHART_KEY, []));
        if (window.__kaspaSurfChart) renderChart(window.__kaspaSurfChart, pts);
      });
    });

    el("ks-clear").addEventListener("click", () => {
      localStorage.removeItem(CHART_KEY);
      if (window.__kaspaSurfChart) renderChart(window.__kaspaSurfChart, []);
    });

    el("ks-clear-all").addEventListener("click", () => {
      try { localStorage.removeItem(CHART_KEY); } catch {}
      try { localStorage.removeItem(LAST_TICKER_KEY); } catch {}
      lastData = null;
      renderTableFromState();
      refreshTicker({ silent: false });
    });

    el("ks-filter").addEventListener("input", renderTableFromState);
    el("ks-sort").addEventListener("change", renderTableFromState);

    refreshTicker({ silent: false });
    setInterval(() => refreshTicker({ silent: true }), POLL_MS);
  })();
  </script>

  <style>
    .ks-wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .ks-header { display:flex; gap:16px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .ks-title { margin:0; font-size: 1.8rem; }
    .ks-sub { opacity:.8; font-size:.95rem; }

    .ks-cards { display:grid; grid-template-columns: repeat(4, minmax(140px, 1fr)); gap:12px; width: min(720px, 100%); }
    .ks-card { background: var(--bg-secondary); border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 12px 14px; }
    .ks-label { opacity:.75; font-size:.85rem; }
    .ks-value { font-size: 1.2rem; font-weight: 700; margin-top: 4px; }

    .ks-grid { display: grid; grid-template-columns: 1fr; gap: 14px; margin-top: 14px; }
    .ks-panel { background: var(--bg-secondary); border: 1px solid rgba(255,255,255,.08); border-radius: 16px; padding: 14px; }
    .ks-panel-head { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .ks-h2 { margin: 0; font-size: 1.1rem; }

    .ks-controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .ks-btn { background: transparent; border: 1px solid rgba(255,255,255,.15); color: var(--text-color); padding: 7px 10px; border-radius: 10px; cursor:pointer; }
    .ks-btn:hover { border-color: rgba(255,255,255,.3); }

    .ks-input, .ks-select {
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text-color);
      padding: 8px 10px;
      border-radius: 10px;
      outline: none;
    }
    .ks-input { min-width: 210px; }

    .ks-tablewrap { overflow:auto; margin-top: 10px; border-radius: 12px; }
    .ks-table { width: 100%; border-collapse: collapse; min-width: 820px; }
    .ks-table th, .ks-table td { padding: 10px 10px; border-bottom: 1px solid rgba(255,255,255,.08); }
    .ks-table thead th { position: sticky; top: 0; background: var(--bg-secondary); z-index: 1; text-align:left; }
    .ks-table td.r, .ks-table th.r { text-align:right; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</main>

<footer>
  <p class="footer-text">&copy; 2025 Kaspa Surf.</p>
</footer>

<script>
  const toggle = document.getElementById('mode-toggle');
  const body = document.body;
  toggle.addEventListener('click', () => {
    body.classList.toggle('dark');
    toggle.textContent = body.classList.contains('dark') ? 'üåô' : '‚òÄÔ∏è';
  });
</script>
</body>
</html>
